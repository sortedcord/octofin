{% extends "downloader/base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <!-- Left Column: Add New Song -->
    <div class="col-md-4 mb-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h2 class="card-title">Add New Song</h2>
          <!-- Button trigger modal -->
          <button class="btn btn-primary btn-lg mt-3" data-bs-toggle="modal" data-bs-target="#addSongModal">
            <i class="bi bi-plus-circle"></i> Add Song
          </button>
          <p class="mt-3 text-muted">Add Songs from YTM to Jellyfin</p>
        </div>
      </div>
    </div>

    <!-- Right Column: Processing Queue -->
    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
          <h2 class="mb-0">Processing Queue</h2>
          <form method="post" action="{% url 'clear_tasks' %}" style="margin: 0;">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-secondary btn-sm"
                    title="Clear All Tasks"
                    onclick="return confirm('Are you sure you want to delete all tasks?');">
              <i class="bi bi-x-circle"></i>
            </button>
          </form>
        </div>
        <div class="card-body">
          <div class="list-group" id="task-queue">
            {% for task in tasks %}
                <a href="{% if task.status == 'ready' %}{% url 'edit' task.id %}{% else %}#{% endif %}"
                   class="list-group-item list-group-item-action d-flex justify-content-between align-items-center
                   {% if task.status == 'ready' %}list-group-item-success{% endif %}">
                    <div>
                        <h5 class="mb-1">{{ task.title|default:"Fetching metadata..." }}</h5>
                        <small class="text-muted">
                            {% if task.status == 'queued' %}Waiting to start{% endif %}
                            {% if task.status == 'fetching' %}Fetching metadata...{% endif %}
                            {% if task.status == 'ready' %}Ready for editing - Click to edit{% endif %}
                            {% if task.status == 'editing' %}Being edited{% endif %}
                            {% if task.status == 'downloading' %}Downloading...{% endif %}
                            {% if task.status == 'importing' %}Importing to library{% endif %}
                            {% if task.status == 'completed' %}Completed!{% endif %}
                            {% if task.status == 'failed' %}Failed - {{ task.metadata.error }}{% endif %}
                        </small>
                    </div>
                    <span class="badge
                        {% if task.status == 'completed' %}bg-success{% endif %}
                        {% if task.status == 'failed' %}bg-danger{% endif %}
                        {% if task.status == 'ready' %}bg-success{% endif %}
                        {% if task.status in 'fetching,downloading,importing' %}bg-primary{% endif %}
                        {% if task.status in 'queued,editing' %}bg-secondary{% endif %}
                        rounded-pill">
                        {{ task.get_status_display }}
                    </span>
                </a>
                {% empty %}
                <div class="text-center py-5" id="empty-queue">
                    <i class="bi bi-music-note-list display-4 text-muted"></i>
                    <p class="mt-3">No songs in processing queue</p>
                </div>
                {% endfor %}
            </div>
        </div>
      </div>
    </div>
  </div>

    <div>
        <h1>Changelog</h1>
        <hr>
        {% for version in changelog %}
            <h2>{{ version.version }}</h2>
            <h4>Added</h4>
            <ul>
            {% for point in version.tag_list.Added %}
                <li>{{ point }}</li>
                {% endfor %}
            </ul>
            <h4>Changed</h4>
            <ul>
                {% for point in version.tag_list.Changed %}
                    <li>{{ point }}</li>
                {% endfor %}
            </ul>
            <h4>Fixed</h4>
            <ul>
                {% for point in version.tag_list.Fixed %}
                    <li>{{ point }}</li>
                {% endfor %}
            </ul>
        {% endfor %}
    </div>
</div>

<!-- Add Song Modal -->
<div class="modal fade" id="addSongModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="addSongForm" method="post" action="{% url 'create_task' %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Song</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">YouTube URL</label>
          <input type="url" class="form-control" id="youtubeUrl" name="url" placeholder="https://music.youtube.com/watch?v=..." required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Add to Queue</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
      </div>
</div>
{% endblock %}


{% block extra_js %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    function getStatusClass(status) {
        if (status === 'completed') return 'success';
        if (status === 'failed') return 'danger';
        if (status === 'ready') return 'success';
        if (['fetching', 'downloading', 'importing'].includes(status)) return 'primary';
        if (['queued', 'editing'].includes(status)) return 'secondary';
        return 'secondary';
    }

    function getStatusText(status) {
        switch (status) {
            case 'queued': return 'Waiting to start';
            case 'fetching': return 'Fetching metadata...';
            case 'ready': return 'Ready for editing - Click to edit';
            case 'editing': return 'Being edited';
            case 'downloading': return 'Downloading...';
            case 'importing': return 'Importing to library';
            case 'completed': return 'Completed!';
            case 'failed': return 'Failed';
            default: return status;
        }
    }

    function updateTaskQueue() {
        fetch('/ytm/queue-status/')
            .then(response => response.json())
            .then(tasks => {
                const queue = document.getElementById('task-queue');
                queue.innerHTML = '';
                if (tasks.length === 0) {
                    queue.innerHTML = `
                      <div class="text-center py-5" id="empty-queue">
                          <i class="bi bi-music-note-list display-4 text-muted"></i>
                          <p class="mt-3">No songs in processing queue</p>
                      </div>
                    `;
                } else {
                    tasks.forEach(task => {
                        const link = (task.status === 'ready') ? `edit/${task.id}/` : '#';
                        queue.innerHTML += `
                          <a href="${link}" 
                             class="list-group-item list-group-item-action d-flex justify-content-between align-items-center ${task.status === 'ready' ? 'list-group-item-success' : ''}">
                              <div>
                                  <h5 class="mb-1">${task.title || 'Fetching metadata...'}</h5>
                                  <small class="text-muted">${getStatusText(task.status)}</small>
                              </div>
                              <span class="badge bg-${getStatusClass(task.status)} rounded-pill">${task.status_display}</span>
                          </a>
                        `;
                    });
                }
            });
    }

    // Update every 5 seconds
    setInterval(updateTaskQueue, 5000);
    // Also update once on page load
    updateTaskQueue();
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('addSongForm');
    const urlInput = form.querySelector('input[name="url"]');
    const modalBody = document.querySelector('#addSongModal .modal-body');

    // Create error alert container if it doesn't exist
    let errorAlert = document.getElementById('url-error-alert');
    if (!errorAlert) {
        errorAlert = document.createElement('div');
        errorAlert.id = 'url-error-alert';
        errorAlert.className = 'alert alert-danger d-none mb-3';
        modalBody.insertBefore(errorAlert, modalBody.firstChild);
    }

    form.addEventListener('submit', function(e) {
        const url = urlInput.value.trim();
        errorAlert.classList.add('d-none');
        errorAlert.textContent = '';

        if (!url) {
            e.preventDefault();
            errorAlert.textContent = 'URL cannot be empty.';
            errorAlert.classList.remove('d-none');
            return;
        }

        if (!url.startsWith('https://music.youtube.com/')) {
            e.preventDefault();
            errorAlert.textContent = 'Invalid URL. Please enter a YouTube Music URL.';
            errorAlert.classList.remove('d-none');
            return;
        }

        if (url.includes('playlist?list=')) {
            e.preventDefault();
            errorAlert.textContent = 'Playlists are not supported yet.';
            errorAlert.classList.remove('d-none');
            return;
        }
    });
});
</script>
{% endblock %}
